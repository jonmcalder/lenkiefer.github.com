caption="@lenkiefer Source: Freddie Mac House Price Index")+
theme(plot.title=element_text(size=14,face="bold"),
plot.subtitle=element_text(size=10,face="italic"),
plot.caption=element_text(hjust=0,size=8),
panel.border = element_blank(),
panel.grid.major = element_blank(),
text=element_text(family="Palatino Linotype"),
panel.grid.minor = element_blank(),
plot.margin=unit(c(0.5,0.5,0.5,0.5),"cm"),
axis.ticks.length=unit(0.25,"cm")) +
geom_point(data=tail(in.dt[hpi>0,],1),color="red",size=3,alpha=0.82)+
base_breaks_y(in.dt$hpi)+
base_breaks_x_date(as.numeric(xlim),xlim,"%b-%Y",xlim)+
geom_hline(yintercept=tail(in.dt,1)$hpi,color="red",linetype=2)
ggplot(data=in.dt, aes(x=as.numeric(date),y=hpi,label=round(hpi,0)))+
geom_line()+theme_bw()+
labs(x="", y="",
title="U.S. house price index",
subtitle="House price index: Dec 2000 = 100, seasonally adjusted",
caption="@lenkiefer Source: Freddie Mac House Price Index")+
theme(plot.title=element_text(size=14,face="bold"),
plot.subtitle=element_text(size=10,face="italic"),
plot.caption=element_text(hjust=0,size=8),
panel.border = element_blank(),
panel.grid.major = element_blank(),
text=element_text(family="Palatino Linotype"),
panel.grid.minor = element_blank(),
plot.margin=unit(c(0.5,0.5,0.5,0.5),"cm"),
axis.ticks.length=unit(0.25,"cm")) +
geom_point(data=tail(in.dt[hpi>0,],1),color="red",size=3,alpha=0.82)+
base_breaks_y(in.dt$hpi)+
base_breaks_x_date(as.numeric(xlim),xlim,"%b-%Y",xlim)+
geom_hline(yintercept=tail(in.dt,1)$hpi,color="red",linetype=2)+
geom_hline(xintercept=as.numeric(in.dt[date=date.max]$date)),linetype=2)
ggplot(data=in.dt, aes(x=as.numeric(date),y=hpi,label=round(hpi,0)))+
geom_line()+theme_bw()+
labs(x="", y="",
title="U.S. house price index",
subtitle="House price index: Dec 2000 = 100, seasonally adjusted",
caption="@lenkiefer Source: Freddie Mac House Price Index")+
theme(plot.title=element_text(size=14,face="bold"),
plot.subtitle=element_text(size=10,face="italic"),
plot.caption=element_text(hjust=0,size=8),
panel.border = element_blank(),
panel.grid.major = element_blank(),
text=element_text(family="Palatino Linotype"),
panel.grid.minor = element_blank(),
plot.margin=unit(c(0.5,0.5,0.5,0.5),"cm"),
axis.ticks.length=unit(0.25,"cm")) +
geom_point(data=tail(in.dt[hpi>0,],1),color="red",size=3,alpha=0.82)+
base_breaks_y(in.dt$hpi)+
base_breaks_x_date(as.numeric(xlim),xlim,"%b-%Y",xlim)+
geom_hline(yintercept=tail(in.dt,1)$hpi,color="red",linetype=2)+
geom_hline(xintercept=as.numeric(in.dt[date==date.max]$date)),linetype=2)
ggplot(data=in.dt, aes(x=as.numeric(date),y=hpi,label=round(hpi,0)))+
geom_line()+theme_bw()+
labs(x="", y="",
title="U.S. house price index",
subtitle="House price index: Dec 2000 = 100, seasonally adjusted",
caption="@lenkiefer Source: Freddie Mac House Price Index")+
theme(plot.title=element_text(size=14,face="bold"),
plot.subtitle=element_text(size=10,face="italic"),
plot.caption=element_text(hjust=0,size=8),
panel.border = element_blank(),
panel.grid.major = element_blank(),
text=element_text(family="Palatino Linotype"),
panel.grid.minor = element_blank(),
plot.margin=unit(c(0.5,0.5,0.5,0.5),"cm"),
axis.ticks.length=unit(0.25,"cm")) +
geom_point(data=tail(in.dt[hpi>0,],1),color="red",size=3,alpha=0.82)+
base_breaks_y(in.dt$hpi)+
base_breaks_x_date(as.numeric(xlim),xlim,"%b-%Y",xlim)+
geom_hline(yintercept=tail(in.dt,1)$hpi,color="red",linetype=2)+
geom_hline(xintercept=as.numeric(in.dt[date==date.max]$date),linetype=2)
ggplot(data=in.dt, aes(x=as.numeric(date),y=hpi,label=round(hpi,0)))+
geom_line()+theme_bw()+
labs(x="", y="",
title="U.S. house price index",
subtitle="House price index: Dec 2000 = 100, seasonally adjusted",
caption="@lenkiefer Source: Freddie Mac House Price Index")+
theme(plot.title=element_text(size=14,face="bold"),
plot.subtitle=element_text(size=10,face="italic"),
plot.caption=element_text(hjust=0,size=8),
panel.border = element_blank(),
panel.grid.major = element_blank(),
text=element_text(family="Palatino Linotype"),
panel.grid.minor = element_blank(),
plot.margin=unit(c(0.5,0.5,0.5,0.5),"cm"),
axis.ticks.length=unit(0.25,"cm")) +
geom_point(data=tail(in.dt[hpi>0,],1),color="red",size=3,alpha=0.82)+
base_breaks_y(in.dt$hpi)+
base_breaks_x_date(as.numeric(xlim),xlim,"%b-%Y",xlim)+
geom_hline(yintercept=tail(in.dt,1)$hpi,color="red",linetype=2)+
geom_vline(xintercept=as.numeric(in.dt[date==date.max]$date),linetype=2)
ggplot(data=in.dt, aes(x=as.numeric(date),y=hpi,label=round(hpi,0)))+
geom_line()+theme_bw()+
labs(x="", y="",
title="U.S. house price index",
subtitle="House price index: Dec 2000 = 100, seasonally adjusted",
caption="@lenkiefer Source: Freddie Mac House Price Index")+
theme(plot.title=element_text(size=14,face="bold"),
plot.subtitle=element_text(size=10,face="italic"),
plot.caption=element_text(hjust=0,size=8),
panel.border = element_blank(),
panel.grid.major = element_blank(),
text=element_text(family="Palatino Linotype"),
panel.grid.minor = element_blank(),
plot.margin=unit(c(0.5,0.5,0.5,0.5),"cm"),
axis.ticks.length=unit(0.25,"cm")) +
geom_point(data=tail(in.dt[hpi>0,],1),color="red",size=3,alpha=0.82)+
base_breaks_y(in.dt$hpi)+
base_breaks_x_date(as.numeric(xlim),xlim,"%b-%Y",xlim)+
geom_hline(yintercept=tail(in.dt,1)$hpi,color="red",linetype=2)+
geom_vline(xintercept=as.numeric(in.dt[date==date.max]$date),
linetype=2,color="lightgray")+
geom_vline(xintercept=as.numeric(in.dt[date==date.min]$date),
linetype=2,color="lightgray")
ggplot(data=in.dt, aes(x=as.numeric(date),y=hpi,label=round(hpi,0)))+
geom_line()+theme_bw()+
labs(x="", y="",
title="U.S. house price index",
subtitle="House price index: Dec 2000 = 100, seasonally adjusted",
caption="@lenkiefer Source: Freddie Mac House Price Index")+
theme(plot.title=element_text(size=14,face="bold"),
plot.subtitle=element_text(size=10,face="italic"),
plot.caption=element_text(hjust=0,size=8),
panel.border = element_blank(),
panel.grid.major = element_blank(),
text=element_text(family="Palatino Linotype"),
panel.grid.minor = element_blank(),
plot.margin=unit(c(0.5,0.5,0.5,0.5),"cm"),
axis.ticks.length=unit(0.25,"cm")) +
geom_point(data=tail(in.dt[hpi>0,],1),color="red",size=3,alpha=0.82)+
base_breaks_y(in.dt$hpi)+
base_breaks_x_date(as.numeric(xlim),xlim,"%b-%Y",xlim)+
geom_hline(yintercept=tail(in.dt,1)$hpi,color="red",linetype=2)+
geom_vline(xintercept=as.numeric(in.dt[date==date.max]$date),
linetype=2,color="lightgray")+
geom_vline(xintercept=as.numeric(in.dt[date==date.min]$date),
linetype=2,color="lightgray")+
geom_text(data=in.dt[date==date.max],label="Pre-2008 Max",hjust=1)
ggplot(data=in.dt, aes(x=as.numeric(date),y=hpi,label=round(hpi,0)))+
geom_line()+theme_bw()+
labs(x="", y="",
title="U.S. house price index",
subtitle="House price index: Dec 2000 = 100, seasonally adjusted",
caption="@lenkiefer Source: Freddie Mac House Price Index")+
theme(plot.title=element_text(size=14,face="bold"),
plot.subtitle=element_text(size=10,face="italic"),
plot.caption=element_text(hjust=0,size=8),
panel.border = element_blank(),
panel.grid.major = element_blank(),
text=element_text(family="Palatino Linotype"),
panel.grid.minor = element_blank(),
plot.margin=unit(c(0.5,0.5,0.5,0.5),"cm"),
axis.ticks.length=unit(0.25,"cm")) +
geom_point(data=tail(in.dt[hpi>0,],1),color="red",size=3,alpha=0.82)+
base_breaks_y(in.dt$hpi)+
base_breaks_x_date(as.numeric(xlim),xlim,"%b-%Y",xlim)+
geom_hline(yintercept=tail(in.dt,1)$hpi,color="red",linetype=2)+
geom_vline(xintercept=as.numeric(in.dt[date==date.max]$date),
linetype=2,color="lightgray")+
geom_vline(xintercept=as.numeric(in.dt[date==date.min]$date),
linetype=2,color="lightgray")+
geom_text(data=in.dt[date==date.max],y=100,label="Pre-2008 Max",hjust=1)
ggplot(data=in.dt, aes(x=as.numeric(date),y=hpi,label=round(hpi,0)))+
geom_line()+theme_bw()+
labs(x="", y="",
title="U.S. house price index",
subtitle="House price index: Dec 2000 = 100, seasonally adjusted",
caption="@lenkiefer Source: Freddie Mac House Price Index")+
theme(plot.title=element_text(size=14,face="bold"),
plot.subtitle=element_text(size=10,face="italic"),
plot.caption=element_text(hjust=0,size=8),
panel.border = element_blank(),
panel.grid.major = element_blank(),
text=element_text(family="Palatino Linotype"),
panel.grid.minor = element_blank(),
plot.margin=unit(c(0.5,0.5,0.5,0.5),"cm"),
axis.ticks.length=unit(0.25,"cm")) +
geom_point(data=tail(in.dt[hpi>0,],1),color="red",size=3,alpha=0.82)+
base_breaks_y(in.dt$hpi)+
base_breaks_x_date(as.numeric(xlim),xlim,"%b-%Y",xlim)+
geom_hline(yintercept=tail(in.dt,1)$hpi,color="red",linetype=2)+
geom_vline(xintercept=as.numeric(in.dt[date==date.max]$date),
linetype=2,color="lightgray")+
geom_vline(xintercept=as.numeric(in.dt[date==date.min]$date),
linetype=2,color="lightgray")+
geom_text(data=in.dt[date==date.max],vjust=1.1,label="Pre-2008 Max",hjust=1,
size=2)
ggplot(data=in.dt, aes(x=as.numeric(date),y=hpi,label=round(hpi,0)))+
geom_line()+theme_bw()+
labs(x="", y="",
title="U.S. house price index",
subtitle="House price index: Dec 2000 = 100, seasonally adjusted",
caption="@lenkiefer Source: Freddie Mac House Price Index")+
theme(plot.title=element_text(size=14,face="bold"),
plot.subtitle=element_text(size=10,face="italic"),
plot.caption=element_text(hjust=0,size=8),
panel.border = element_blank(),
panel.grid.major = element_blank(),
text=element_text(family="Palatino Linotype"),
panel.grid.minor = element_blank(),
plot.margin=unit(c(0.5,0.5,0.5,0.5),"cm"),
axis.ticks.length=unit(0.25,"cm")) +
geom_point(data=tail(in.dt[hpi>0,],1),color="red",size=3,alpha=0.82)+
base_breaks_y(in.dt$hpi)+
base_breaks_x_date(as.numeric(xlim),xlim,"%b-%Y",xlim)+
geom_hline(yintercept=tail(in.dt,1)$hpi,color="red",linetype=2)+
geom_vline(xintercept=as.numeric(in.dt[date==date.max]$date),
linetype=2,color="lightgray")+
geom_vline(xintercept=as.numeric(in.dt[date==date.min]$date),
linetype=2,color="lightgray")+
geom_text(data=in.dt[date==date.max],vjust=-.1,label="Pre-2008 Max",hjust=1,
size=2)
ggplot(data=in.dt, aes(x=as.numeric(date),y=hpi,label=round(hpi,0)))+
geom_line()+theme_bw()+
labs(x="", y="",
title="U.S. house price index",
subtitle="House price index: Dec 2000 = 100, seasonally adjusted",
caption="@lenkiefer Source: Freddie Mac House Price Index")+
theme(plot.title=element_text(size=14,face="bold"),
plot.subtitle=element_text(size=10,face="italic"),
plot.caption=element_text(hjust=0,size=8),
panel.border = element_blank(),
panel.grid.major = element_blank(),
text=element_text(family="Palatino Linotype"),
panel.grid.minor = element_blank(),
plot.margin=unit(c(0.5,0.5,0.5,0.5),"cm"),
axis.ticks.length=unit(0.25,"cm")) +
geom_point(data=tail(in.dt[hpi>0,],1),color="red",size=3,alpha=0.82)+
base_breaks_y(in.dt$hpi)+
base_breaks_x_date(as.numeric(xlim),xlim,"%b-%Y",xlim)+
geom_hline(yintercept=tail(in.dt,1)$hpi,color="red",linetype=2)+
geom_vline(xintercept=as.numeric(in.dt[date==date.max]$date),
linetype=2,color="lightgray")+
geom_vline(xintercept=as.numeric(in.dt[date==date.min]$date),
linetype=2,color="lightgray")+
geom_text(data=in.dt[date==date.max],y=101,label="Pre-2008 Max",hjust=1,
size=2)+
geom_text(data=in.dt[date==date.min],y=101,label="Post-2008 Min",hjust=0,
size=2)
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
#Animate plot
oopt = ani.options(interval = 0.1)
saveGIF({for (i in 1:max(tf$.frame)) { #loop over frames
g<-
myp(tf[.frame==i],xlim=xlim,ylim=ylim,in.name="House price trends in the U.S.")
print(g)
ani.pause()
print(i)}
for (i in 1:10){
print(g)
ani.pause()
}
},movie.name="tween test US hpi 02 18 2017.gif",ani.width = 500, ani.height = 400)
# Set limits for  axis
xlim<-c(as.numeric(min(dt2$date)),as.numeric(max(dt2$date)))
ylim<-c(as.numeric(min(dt2$hpi)),as.numeric(max(dt2$hpi)))
#c(min(dt2$date),dt2[,min(date),by=year(date)]$V1,max(dt2$date))
my.list2<-lapply(c(dt2[(year(date) %in% c(1959,1969,1979,1989,1999)|year(date)>1999),
max(date),by=year(date)]$V1,max(dt2$date)) ,myf)
my.list2<-lapply(c(max(dt2$date),min(dt2$date),s.max[state=="CA"]$date.max,s.min[state=="CA"]$date.min,max(dt2$date)),myf)
#use tweenr to interploate
tf <- tween_states(my.list2,tweenlength= 3,
statelength=1, ease=rep('cubic-in-out',2),nframes=30)
tf<-data.table(unique(tf)) #convert output into data table
#tf<-tf[.frame<40]
#Animate plot
oopt = ani.options(interval = 0.1)
saveGIF({for (i in 1:max(tf$.frame)) { #loop over frames
g<-
myp(tf[.frame==i],xlim=xlim,ylim=ylim,in.name="House price trends in the U.S.")
print(g)
ani.pause()
print(i)}
for (i in 1:10){
print(g)
ani.pause()
}
},movie.name="tween test US hpi 02 18 2017.gif",ani.width = 500, ani.height = 400)
getwd()
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
statedata[state=="US.SA"]
168.2431/165.1079
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
#set a maximum date with year and month
yy<-2016 #year
mm<-12   #month- march is latest available
#Create the plot, exlude if state = 'US' or state = 'DC', and year < 2000:
g<-
ggplot(data=statedata[state != "US.SA" & state != "US.NSA" & state !="DC" & year>1999 ], aes(x=date,y=hpi))+
#set theme
theme_minimal()+
#set dates,
#the axis will be tight so we'll only show the year every 4 years and only print the last 2 digits
scale_x_date(labels= date_format("%y"),date_breaks="4 year",
limits = as.Date(c('2000-01-01','2016-03-30'))) +
#set y axis, I prefer a log axis for indices like this
scale_y_log10(limits=c(70,350), breaks=c(75,100,125,150,200,250,350))+
#plot data with black line
geom_line(color="black")  +
#add a marker at teh end
geom_point(data=statedata[state !='US' & state != "DC" & year==yy & month==mm], color="red", alpha=0.7)+
#use the facet feature to plot each state as it's own small plot
facet_wrap(~state, ncol=10) +
# add a horiztonal line at the last data point, helpufl to compare to prior peak
geom_hline(data = statedata[year==yy & month==mm& state !="US" & state !="DC"], aes(yintercept = hpi), linetype=2,alpha=0.8)+
#modify plot features
theme(plot.title=element_text(face="bold",size=12))+
theme(plot.caption=element_text(hjust=0))+
xlab("")+ylab("House price index, log scale")+
#create a subtitle that prints the last date, useful later
labs(caption="@lenkiefer Source: Freddie Mac House Price Index (Dec 2000 = 100, NSA)",
subtitle=paste(as.character(statedata[year==yy & month==mm & state=="US"]$date,format="%b-%Y")),
title="State house price trends")
g
ggplot(data=statedata[state != "US.SA" & state != "US.NSA" & state !="DC" & year>1999 ], aes(x=date,y=hpi))+
#set theme
theme_minimal()+
#set dates,
#the axis will be tight so we'll only show the year every 4 years and only print the last 2 digits
scale_x_date(labels= date_format("%y"),date_breaks="4 year",
limits = as.Date(c('2000-01-01','2016-03-30'))) +
#set y axis, I prefer a log axis for indices like this
scale_y_log10(limits=c(70,350), breaks=c(75,100,125,150,200,250,350))+
#plot data with black line
geom_line(color="black")  +
#add a marker at teh end
geom_point(data=statedata[state !='US' & state != "DC" & year==yy & month==mm], color="red", alpha=0.7)+
#use the facet feature to plot each state as it's own small plot
facet_wrap(~state, ncol=10) +
# add a horiztonal line at the last data point, helpufl to compare to prior peak
geom_hline(data = statedata[year==yy & month==mm& state !="US" & state !="DC"], aes(yintercept = hpi), linetype=2,alpha=0.8)+
#modify plot features
theme(plot.title=element_text(face="bold",size=12))+
theme(plot.caption=element_text(hjust=0))+
xlab("")+ylab("House price index, log scale")+
#create a subtitle that prints the last date, useful later
labs(caption="@lenkiefer Source: Freddie Mac House Price Index (Dec 2000 = 100, NSA)",
subtitle="data through December 2016",
title="State house price trends")
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
yy<-2016
mm<-12
ggplot(data=statedata[(year==yy) & month==mm & state !="DC" & state !="US.SA" & state !="US.NSA"], aes(x=hpi, y=reorder(state,hpi), label=state,color=hpa12))+
geom_text(nudge_x = 0.025)  +
geom_point()+scale_x_log10(limits=c(70,350), breaks=c(70,100,150,250,350))+
geom_segment(aes(xend=hpi12min,x=hpi12max,y=reorder(state,hpi),yend=reorder(state,hpi)),alpha=0.7)+
theme_minimal()  +
scale_colour_gradient(low="red",high="blue",name = "12-month percent change",labels = percent)+
labs(y="State", x="House price index (log scale, Dec 2000 =100, NSA)",
title="State house price dynamics",
subtitle=paste(as.character(statedata[year==yy & month==mm & state=="US.SA"]$date,format="%b-%Y")),
caption="@lenkiefer Source: Freddie Mac house price index, each dot a state, lines trailing 12-month min-max")+
theme(plot.title=element_text(size=18),
plot.caption=element_text(hjust=0,vjust=1,margin=margin(t=10)),
plot.margin=unit(c(0.25,0.25,0.25,0.25),"cm"),
legend.key.width=unit(2.5,"cm"),
legend.position="top",
axis.text.y=element_blank(),
axis.title.y=element_blank(),
panel.grid.major.y =element_blank())
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
g<-
ggplot(data=statedata[state != "US.SA" & state != "US.NSA" & state !="DC" & year>1999 ], aes(x=date,y=hpi))+
#set theme
theme_minimal()+
#set dates,
#the axis will be tight so we'll only show the year every 4 years and only print the last 2 digits
scale_x_date(labels= date_format("%y"),date_breaks="4 year",
limits = as.Date(c('2000-01-01','2016-12-31'))) +
#set y axis, I prefer a log axis for indices like this
scale_y_log10(limits=c(70,350), breaks=c(75,100,125,150,200,300))+
#plot data with black line
geom_line(color="black")  +
#add a marker at teh end
geom_point(data=statedata[state != "US.SA" & state != "US.NSA" & state != "DC" & year==yy & month==mm], color="red", alpha=0.7)+
#use the facet feature to plot each state as it's own small plot
facet_wrap(~state, ncol=5) +
# add a horiztonal line at the last data point, helpufl to compare to prior peak
geom_hline(data = statedata[year==yy & month==mm & state != "US.SA" & state != "US.NSA" & state !="DC"], aes(yintercept = hpi), linetype=2,alpha=0.8)+
#modify plot features
theme(plot.title=element_text(face="bold",size=12))+
theme(plot.caption=element_text(hjust=0))+
xlab("")+ylab("House price index, log scale")+
#create a subtitle that prints the last date, useful later
labs(caption="@lenkiefer Source: Freddie Mac House Price Index (Dec 2000 = 100, NSA)",
subtitle="data through December 2016",
title="State house price trends")
g
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
dm3
getwd()
# Red blue dot gif 2016 Q4
library(data.table, warn.conflicts = FALSE, quietly=TRUE)
library(zoo, warn.conflicts = FALSE, quietly=TRUE)
library(ggrepel, warn.conflicts = FALSE, quietly=TRUE)
library(ggthemes, warn.conflicts = FALSE, quietly=TRUE)
library(scales, warn.conflicts = FALSE, quietly=TRUE)
library(animation, warn.conflicts = FALSE, quietly=TRUE)
library(tweenr, warn.conflicts = FALSE, quietly=TRU)
library(tidyverse, warn.conflicts = FALSE, quietly=TRUE)
library(maps, warn.conflicts = FALSE, quietly=TRUE)
source("code/multiplot.R")
#load national & state data
statedata <- fread("data/fmhpi2016q4.txt")
statedata$date<-as.Date(statedata$date, format="%m/%d/%Y")
#Now uses some data table caclulations to compute percent changes in house prices by state/metro
statedata<-statedata[,hpa:=c(NA,((1+diff(hpi)/hpi))^12)-1,by=state]
statedata<-statedata[,hpa12:=c(rep(NA,12),((1+diff(hpi,12)/hpi))^1)-1,by=state]
#create lags of state
statedata<-statedata[, hpi12 :=  shift(hpi,12), by=state]
#compute rolling min/max
statedata<-statedata[, hpi12min:=rollapply(hpi, 12, min,fill=NA, na.rm=FALSE,align='right'), by=state]
statedata<-statedata[, hpi12max:=rollapply(hpi, 12, max,fill=NA, na.rm=FALSE,align='right'), by=state]
#compute pre-2008 peak
statedata=statedata[,hpi.max08:=max(ifelse(year<2008,hpi,0),na.rm=T),by=state]
#compute post-2008 trough
statedata=statedata[,hpi.min08:=min(ifelse(year>2008,hpi,1000),na.rm=T),by=state]
#myp(statedata[state=="CA"& date>="2000-12-01"], in.name="CA")
# get dates of max/min
s.min<-statedata[hpi==hpi.min08][,date.min:=date][,c("state","date.min")]
s.max<-statedata[hpi==hpi.max08][,date.max:=date][,c("state","date.max")]
dt<-merge(statedata[date>="2000-12-01"],s.min,by="state")
dt<-merge(dt,s.max,by="state")
dt2<-dt[state=="US.SA"]
data(us.cities) # from the package maps
cbsa.data <-fread("data/cbsa.city.txt")
cbsa.metro<-cbsa.data[metro.micro=="Metropolitan Statistical Area"]
#create lowercase names
cbsa.metro[,nameL:=tolower(name)]
us.cities<-data.table(us.cities)[,nameL:=tolower(name)]
d<-merge(cbsa.metro,us.cities,by="nameL")
#get rid of duplicates
# see: http://stackoverflow.com/questions/15776064/r-first-observation-by-group-using-data-table-self-join
d<-d[order(-pop)]
d<-d[d[,list(row1 = .I[1]), by = list(cbsa)][,row1]]
dm<-fread("data/fmhpi2016q4metro.txt")
dm$date<-as.Date(dm$date, format="%m/%d/%Y")
#compute year-over-year house price growth
dm[,hpa12:=hpi/shift(hpi,12,fill=NA)-1,by=metro]
setkey(d,cbsa.name)
setkey(dm,metro)
cbsa.list<-unique(d$cbsa.name)
metro.list<-unique(dm$metro)
dm2<-merge(dm,d,by.y="cbsa.name",by.x="metro",all.x=T)
#load regions
regions<-fread("data/region.txt")
dm2<-merge(dm2,regions,by.x="state",by.y="statecode")
#compute rolling min/max
dm2<-dm2[, hpi12min:=rollapply(hpi, 12, min,fill=NA, na.rm=FALSE,align='right'), by=state]
dm2<-dm2[, hpi12max:=rollapply(hpi, 12, max,fill=NA, na.rm=FALSE,align='right'), by=state]
dm3<-dm2[year(date)>1999 & state %in% c("TX","FL","CA","OH")]
dm3
ggplot(data=dm3[date==dlist[i] & state=="TX"],
aes(x=hpi,y=metro,color=hpa12,label=metro))+
geom_text(nudge_x = 0.025,hjust=0)  +
facet_wrap(~state,scales="free_y")+geom_point()+
geom_point()+scale_x_log10(limits=c(70,350), breaks=c(70,100,150,250,350))+
geom_segment(aes(xend=hpi12min,x=hpi12max,y=metro,yend=metro),alpha=0.7)+
theme_minimal()  +
scale_colour_gradient(low="red",high="blue",name = "12-month percent change",labels = percent)+
labs(y="Metro", x="House price index (log scale, Dec 2000 =100, NSA)",
title="House price dynamics in Texas metros",
subtitle=paste(as.character(dlist[i],format="%b-%Y")),
caption="@lenkiefer Source: Freddie Mac house price index, each dot a state, lines trailing 12-month min-max")+
theme(plot.title=element_text(size=18),
plot.caption=element_text(hjust=0,vjust=1,margin=margin(t=10)),
plot.margin=unit(c(0.25,0.25,0.25,0.25),"cm"),
legend.key.width=unit(2.5,"cm"),
legend.position="top",
axis.text.y=element_blank(),
axis.title.y=element_blank(),
panel.grid.major.y =element_blank())
ggplot(data=dm3[date=="2016-12-01" & state=="TX"],
aes(x=hpi,y=metro,color=hpa12,label=metro))+
geom_text(nudge_x = 0.025,hjust=0)  +
facet_wrap(~state,scales="free_y")+geom_point()+
geom_point()+scale_x_log10(limits=c(70,350), breaks=c(70,100,150,250,350))+
geom_segment(aes(xend=hpi12min,x=hpi12max,y=metro,yend=metro),alpha=0.7)+
theme_minimal()  +
scale_colour_gradient(low="red",high="blue",name = "12-month percent change",labels = percent)+
labs(y="Metro", x="House price index (log scale, Dec 2000 =100, NSA)",
title="House price dynamics in Texas metros",
subtitle=paste(as.character("2016-12-01",format="%b-%Y")),
caption="@lenkiefer Source: Freddie Mac house price index, each dot a state, lines trailing 12-month min-max")+
theme(plot.title=element_text(size=18),
plot.caption=element_text(hjust=0,vjust=1,margin=margin(t=10)),
plot.margin=unit(c(0.25,0.25,0.25,0.25),"cm"),
legend.key.width=unit(2.5,"cm"),
legend.position="top",
axis.text.y=element_blank(),
axis.title.y=element_blank(),
panel.grid.major.y =element_blank())
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
dm3[metro=="Salina CA"]
dm3[metro=="Salinas, CA"]
dm3[state=="TX" and hpa12<0 & date=="2016-12-01"]
dm3[state=="TX" & hpa12<0 & date=="2016-12-01"]
dm3[state=="TX" & date=="2016-12-01"][order(-hpa12)]
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
KnitPost(site.path="C:/Users/Leonard/Documents/webpage/live/lenkiefer.github.com/", overwriteAll=T, overwriteOne=NULL)
